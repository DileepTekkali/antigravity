{% extends 'base.html' %}

{% block title %}Create Bill - Invoice Generator{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Create New Bill</h1>
    <p class="page-subtitle">{{ template.business_name }}</p>
</div>

<form class="bill-form" method="POST" id="billForm">
    <div class="form-section">
        <h2 class="section-title">Bill Details</h2>
        <div class="form-group">
            <label for="bill_date" class="form-label">Bill Date</label>
            <input type="date" id="bill_date" name="bill_date" class="form-input" value="{{ default_date }}" required>
        </div>
    </div>

    <!-- Customer Details -->
    <div class="form-section">
        <h2 class="section-title">Customer Details</h2>

        <div class="form-group">
            <label for="customer_name" class="form-label">Customer Name *</label>
            <input type="text" id="customer_name" name="customer_name" class="form-input" required
                placeholder="Enter customer name">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="customer_mobile" class="form-label">Mobile Number</label>
                <input type="tel" id="customer_mobile" name="customer_mobile" class="form-input" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="customer_address" class="form-label">Address</label>
                <input type="text" id="customer_address" name="customer_address" class="form-input"
                    placeholder="Optional">
            </div>
        </div>
    </div>

    <!-- Items Section -->
    <div class="form-section">
        <h2 class="section-title">Items</h2>

        <div class="items-table-header">
            <div>Item Name</div>
            <div style="text-align: right">Qty</div>
            <div style="text-align: right">Rate</div>
            <div style="text-align: right">Amount</div>
            <div></div>
        </div>

        <div class="items-container" id="itemsContainer">
            <div class="item-row" data-index="0">
                <input type="text" name="item_name[]" class="form-input item-name" placeholder="Item name" required>
                <input type="number" name="quantity[]" class="form-input item-qty" placeholder="0" min="0" step="0.01"
                    value="1" required style="text-align: right">
                <input type="number" name="rate[]" class="form-input item-rate" placeholder="0.00" min="0" step="0.01"
                    required style="text-align: right">
                <div class="item-amount">₹0.00</div>
                <button type="button" class="btn-remove" onclick="removeItem(this)"
                    style="visibility: hidden;">×</button>
            </div>
        </div>

        <button type="button" class="btn btn-outline btn-full" onclick="addItem()" style="margin-top: 10px;">
            + Add Item
        </button>
    </div>

    <!-- GST Section -->
    <div class="form-section">
        <div class="toggle-group">
            <label class="toggle-label">
                <input type="checkbox" id="gstEnabled" name="gst_enabled" class="toggle-input">
                <span class="toggle-slider"></span>
                <span>Enable GST</span>
            </label>
        </div>

        <div class="gst-options" id="gstOptions" style="display: none; margin-top: 15px;">
            <div class="form-group">
                <label for="gst_percentage" class="form-label">GST Percentage (%)</label>
                <input type="number" id="gst_percentage" name="gst_percentage" class="form-input" placeholder="18"
                    min="0" max="100" step="0.01" value="18">
            </div>
            {% if template.gst_number %}
            <p class="form-hint">GSTIN: {{ template.gst_number }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Totals Section -->
    <div class="totals-section">
        <div class="total-row">
            <span>Subtotal</span>
            <span id="subtotal">₹0.00</span>
        </div>
        <div class="total-row" id="gstRow" style="display: none;">
            <span>GST (<span id="gstLabel">18</span>%)</span>
            <span id="gstAmount">₹0.00</span>
        </div>
        <div class="total-row grand-total">
            <span>Grand Total</span>
            <span id="grandTotal">₹0.00</span>
        </div>
    </div>

    <div class="form-actions" style="margin-top: 32px;">
        <button type="submit" class="btn btn-primary btn-large btn-full">
            Generate Bill
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    let itemIndex = 1;

    function addItem() {
        const container = document.getElementById('itemsContainer');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.dataset.index = itemIndex;

        newRow.innerHTML = `
            <input type="text" name="item_name[]" class="form-input item-name" placeholder="Item name" required>
            <input type="number" name="quantity[]" class="form-input item-qty" placeholder="0" min="0" step="0.01" value="1" required style="text-align: right">
            <input type="number" name="rate[]" class="form-input item-rate" placeholder="0.00" min="0" step="0.01" required style="text-align: right">
            <div class="item-amount">₹0.00</div>
            <button type="button" class="btn-remove" onclick="removeItem(this)">×</button>
        `;

        container.appendChild(newRow);
        itemIndex++;

        const newItemName = newRow.querySelector('.item-name');
        newItemName.focus();
        updateRemoveButtons();
        addRowEventListeners(newRow);
    }

    function removeItem(btn) {
        btn.closest('.item-row').remove();
        updateRemoveButtons();
        calculateTotals();
    }

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.item-row');
        rows.forEach((row, index) => {
            const btn = row.querySelector('.btn-remove');
            if (btn) btn.style.visibility = rows.length > 1 ? 'visible' : 'hidden';
        });
    }

    function addRowEventListeners(row) {
        const qty = row.querySelector('.item-qty');
        const rate = row.querySelector('.item-rate');
        qty.addEventListener('input', () => calculateRowAmount(row));
        rate.addEventListener('input', () => calculateRowAmount(row));
    }

    function calculateRowAmount(row) {
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
        const amount = qty * rate;
        row.querySelector('.item-amount').textContent = `₹${amount.toFixed(2)}`;
        calculateTotals();
    }

    function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            subtotal += qty * rate;
        });

        document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;

        const gstEnabled = document.getElementById('gstEnabled').checked;
        const gstPercentage = parseFloat(document.getElementById('gst_percentage').value) || 0;

        let gstAmount = 0;
        if (gstEnabled) {
            gstAmount = subtotal * gstPercentage / 100;
            document.getElementById('gstAmount').textContent = `₹${gstAmount.toFixed(2)}`;
            document.getElementById('gstLabel').textContent = gstPercentage;
        }

        const grandTotal = subtotal + gstAmount;
        document.getElementById('grandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const firstRow = document.querySelector('.item-row');
        addRowEventListeners(firstRow);

        document.getElementById('gstEnabled').addEventListener('change', function () {
            document.getElementById('gstOptions').style.display = this.checked ? 'block' : 'none';
            document.getElementById('gstRow').style.display = this.checked ? 'flex' : 'none';
            calculateTotals();
        });

        document.getElementById('gst_percentage').addEventListener('input', calculateTotals);
    });
</script>
{% endblock %}