{% extends "base.html" %}

{% block title %}Admin Dashboard - Invoice Generator{% endblock %}

{% block content %}
<style>
    .search-box {
        position: relative;
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
    }

    .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
    }

    .table-header {
        background: var(--bg-primary);
        padding: 16px;
        font-weight: 600;
        font-size: 14px;
        display: grid;
        grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr 2.5fr;
        gap: 16px;
    }

    .table-row {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr 2.5fr;
        gap: 16px;
        align-items: center;
        font-size: 14px;
    }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div style="margin-bottom: 24px;">
    {% for category, message in messages %}
    <div class="flash {{ category }}" style="padding: 12px 16px; border-radius: 6px; margin-bottom: 10px; font-size: 14px; 
                    {% if category == 'success' %}background: var(--success-bg); color: var(--success); border: 1px solid var(--success);
                    {% elif category == 'error' %}background: var(--error-bg); color: var(--error); border: 1px solid var(--error);
                    {% elif category == 'warning' %}background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning);
                    {% else %}background: #e0f2fe; color: #0369a1; border: 1px solid #0369a1;{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="admin-header"
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 32px; border-radius: 12px; margin-bottom: 32px;">
    <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">ğŸ‘‘ Admin Dashboard</h1>
    <p style="opacity: 0.9; font-size: 16px;">Manage users and monitor system activity</p>
</div>

<div class="stats-grid"
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div class="stat-card"
        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; text-align: center;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘¥</div>
        <div style="font-size: 36px; font-weight: 700; color: var(--brand-primary); margin-bottom: 4px;">{{ total_users
            }}</div>
        <div style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">Total Users</div>
    </div>
    <div class="stat-card"
        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; text-align: center;">
        <div style="font-size: 32px; margin-bottom: 12px;">â³</div>
        <div style="font-size: 36px; font-weight: 700; color: var(--brand-primary); margin-bottom: 4px;">{{
            pending_users }}</div>
        <div style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">Pending Approval</div>
    </div>
    <div class="stat-card"
        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; text-align: center;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“„</div>
        <div style="font-size: 36px; font-weight: 700; color: var(--brand-primary); margin-bottom: 4px;">{{ total_bills
            }}</div>
        <div style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">Total Bills</div>
    </div>
</div>

<!-- Pending Users Section -->
<div style="margin-bottom: 40px;">
    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">â³ Pending Approvals</h2>
    <div class="users-table"
        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        {% if pending %}
        <div class="table-header">
            <div>Business Name</div>
            <div>Email</div>
            <div>Owner</div>
            <div>GST</div>
            <div>Registered</div>
            <div>Actions</div>
        </div>
        {% for user in pending %}
        <div class="table-row">
            <div><strong>{{ user.business_name }}</strong></div>
            <div>{{ user.email }}</div>
            <div>{{ user.owner_name }}</div>
            <div>
                {% if user.gst_verified %}
                <span class="badge badge-success"
                    style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--success-bg); color: var(--success);">âœ“
                    Verified</span>
                {% else %}
                <span class="badge badge-warning"
                    style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--warning-bg); color: var(--warning);">Not
                    Verified</span>
                {% endif %}
            </div>
            <div style="font-size: 12px; color: var(--text-muted);">{{ user.created_at[:10] }}</div>
            <div style="display: flex; gap: 8px;">
                <a href="{{ url_for('approve_user', user_id=user.id) }}" class="btn btn-success btn-small"
                    style="padding: 6px 12px; font-size: 12px; background: var(--success); color: white; text-decoration: none; border-radius: 6px;"
                    onclick="return confirm('Approve {{ user.business_name }}?')">âœ“ Approve</a>
                <a href="{{ url_for('reject_user', user_id=user.id) }}" class="btn btn-danger btn-small"
                    style="padding: 6px 12px; font-size: 12px; background: var(--error); color: white; text-decoration: none; border-radius: 6px;"
                    onclick="return confirm('Reject and delete {{ user.business_name }}?')">âœ— Reject</a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">âœ…</div>
            <p>No pending approvals</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- All Users Section -->
<div>
    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">ğŸ‘¥ All Users</h2>

    <!-- Search Box -->
    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="userSearch" class="search-input"
            placeholder="Search by business name, owner name, or email...">
    </div>

    <div class="users-table"
        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        {% if all_users %}
        <div class="table-header">
            <div>Business Name</div>
            <div>Email (Username)</div>
            <div>Owner</div>
            <div>Status</div>
            <div>Joined</div>
            <div>Actions</div>
        </div>
        <div id="usersList">
            {% for user in all_users %}
            <div class="table-row user-row" data-business="{{ user.business_name|lower }}"
                data-owner="{{ user.owner_name|lower }}" data-email="{{ user.email|lower }}">
                <div><strong>{{ user.business_name }}</strong></div>
                <div>{{ user.email }}</div>
                <div>{{ user.owner_name }}</div>
                <div>
                    {% if user.is_approved and user.is_active %}
                    <span class="badge badge-success"
                        style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--success-bg); color: var(--success);">Active</span>
                    {% elif not user.is_approved %}
                    <span class="badge badge-warning"
                        style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--warning-bg); color: var(--warning);">Pending</span>
                    {% else %}
                    <span class="badge badge-error"
                        style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--error-bg); color: var(--error);">Inactive</span>
                    {% endif %}
                </div>
                <div style="font-size: 12px; color: var(--text-muted);">{{ user.created_at[:10] }}</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    {% if user.is_approved and not user.is_admin %}
                    <a href="{{ url_for('toggle_user_active', user_id=user.id) }}" class="btn btn-secondary btn-small"
                        style="padding: 6px 12px; font-size: 12px; text-decoration: none; border-radius: 6px;"
                        onclick="return confirm('{% if user.is_active %}Deactivate{% else %}Activate{% endif %} {{ user.business_name }}?')">
                        {% if user.is_active %}ğŸ”’ Deactivate{% else %}ğŸ”“ Activate{% endif %}
                    </a>
                    <a href="{{ url_for('delete_user', user_id=user.id) }}" class="btn btn-danger btn-small"
                        style="padding: 6px 12px; font-size: 12px; background: var(--error); color: white; text-decoration: none; border-radius: 6px;"
                        onclick="return confirm('Permanently delete {{ user.business_name }}? This cannot be undone!')">ğŸ—‘ï¸
                        Delete</a>
                    {% elif user.is_admin %}
                    <span style="font-size: 12px; color: var(--text-muted);">Admin Account</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">ğŸ‘¥</div>
            <p>No users registered yet</p>
        </div>
        {% endif %}
    </div>
</div>

<div style="text-align: center; margin-top: 40px;">
    <a href="{{ url_for('index') }}" class="btn btn-secondary" style="text-decoration: none;">â† Back to Dashboard</a>
</div>

<script>
    // Search functionality
    const searchInput = document.getElementById('userSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');

            rows.forEach(row => {
                const business = row.dataset.business;
                const owner = row.dataset.owner;
                const email = row.dataset.email;

                if (business.includes(query) || owner.includes(query) || email.includes(query)) {
                    row.style.display = 'grid';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
</script>
{% endblock %}